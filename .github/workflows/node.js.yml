name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 14

    - name: Install Dependencies
      run: npm install

    - name: Build React App
      run: npm run build

    - name: Build Docker Image
      run: |
        docker build -t vegahr/personal-portfolio:tagname .
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push vegahr/personal-portfolio:tagname

    - name: Deploy to Server
      run: |
        # Variables
        SERVER_IP=${{ secrets.SERVER_IP }}
        SSH_PORT=${{ secrets.SSH_PORT }}
        SSH_USER=${{ secrets.SSH_USER }}
        SSH_PRIVATE_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
        SOURCE_DIR=build

        # Save SSH private key to a file
        echo "$SSH_PRIVATE_KEY" > ssh_key
        chmod 600 ssh_key

        # Copy files using rsync
        rsync -e "ssh -p $SSH_PORT -i ssh_key" -r $SOURCE_DIR $SSH_USER@$SERVER_IP:/path/to/remote/directory

        # Clean up
        rm ssh_key
